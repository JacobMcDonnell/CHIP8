#include "chip8.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define PROGRAMSTART	0x200

/* 16 8-bit registers */
uint8_t V[16] = {0};

/* program counter 0x200 is starting addr for programs */
uint16_t pc = PROGRAMSTART;

uint16_t indexRegister = 0;

uint8_t stack[64] = {0};
uint8_t stackPointer = 0;


/* main memory: 4096 bytes
 * 0x000 - 0x080: Font Set
 * 0x081 - 0x1FF: Interpreter
 * 0x200 - 0xFFF: Program Space */
uint8_t memory[4096] = {0};

const uint8_t sprites[80] = {
	0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
	0x20, 0x60, 0x20, 0x20, 0x70, // 1
	0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
	0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
	0x90, 0x90, 0xF0, 0x10, 0x10, // 4
	0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
	0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
	0xF0, 0x10, 0x20, 0x40, 0x40, // 7
	0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
	0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
	0xF0, 0x90, 0xF0, 0x90, 0x90, // A
	0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
	0xF0, 0x80, 0x80, 0x80, 0xF0, // C
	0xE0, 0x90, 0x90, 0x90, 0xE0, // D
	0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
	0xF0, 0x80, 0xF0, 0x80, 0x80  // F
};

void initCpu(void)
{
	/* Copy the sprites into the first 80 bytes into memory */
	memcpy(memory, sprites, sizeof(sprites));
}

int loadRom(char *file)
{
	FILE *fp = fopen(file, "rb");
	if (fp == NULL) {
		fprintf(stderr, "Error opening file %s\n", file);
		exit(1);
	}
	size_t readSize = fread(memory + PROGRAMSTART, 1, sizeof(memory) - PROGRAMSTART, fp);

	fclose(fp);
	return 0;
}

int cycleCpu(void)
{
	if (pc >= 4096)
		return 0;
	uint8_t instruction = memory[pc];
	printf("%3x: %2x\n", pc, instruction);
	pc++;
	return cycleCpu();
}

